{% extends 'base.html' %}

{% block title %}Nuevo Movimiento - Bodega de Belén{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="mb-2"><i class="bi bi-plus-circle"></i> Registrar Movimiento de Inventario</h1>
    <p class="text-muted">Entrada, salida o ajuste de stock</p>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <form method="post" id="movimientoForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="producto" class="form-label">Producto *</label>
                        <select name="producto" id="producto" class="form-select select2-producto" required>
                            <option value="">Seleccione un producto...</option>
                            {% for producto in productos %}
                            <option value="{{ producto.id }}" data-stock="{{ producto.cantidad }}">
                                {{ producto.codigo }} - {{ producto.nombre }} (Stock actual: {{
                                producto.cantidad|floatformat:3 }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="tipo" class="form-label">Tipo de Movimiento *</label>
                        <select name="tipo" id="tipo" class="form-select" required>
                            <option value="">Seleccione el tipo...</option>
                            <option value="ENTRADA">➕ Entrada (Comprar/Reponer Stock)</option>
                            <option value="SALIDA">➖ Salida (Pérdida/Dañado)</option>
                            <option value="AJUSTE">⚙️ Ajuste (Inventario Físico)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="cantidad" class="form-label">Cantidad *</label>
                        <input type="number" name="cantidad" id="cantidad" class="form-control" min="0.001" step="0.001"
                            required>
                        <small class="form-text text-muted" id="cantidadHelp"></small>
                    </div>

                    <div class="mb-3">
                        <label for="motivo" class="form-label">Motivo *</label>
                        <textarea name="motivo" id="motivo" class="form-control" rows="3"
                            placeholder="Describe el motivo de este movimiento..." required></textarea>
                        <small class="form-text text-muted">
                            Ejemplos: "Compra de mercancía", "Venta directa", "Productos vencidos", "Corrección de
                            inventario"
                        </small>
                    </div>

                    <div class="alert alert-info" id="previewAlert" style="display: none;">
                        <strong><i class="bi bi-info-circle"></i> Vista Previa:</strong>
                        <div id="previewContent"></div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Registrar Movimiento
                        </button>
                        <a href="{% url 'inventario:movimiento_list' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Tipos de Movimiento</h5>
            </div>
            <div class="card-body">
                <h6><i class="bi bi-arrow-down-circle text-success"></i> Entrada</h6>
                <p class="small">Usa este tipo cuando recibas nueva mercancía. Se SUMARÁ al stock actual.</p>

                <h6><i class="bi bi-arrow-up-circle text-danger"></i> Salida</h6>
                <p class="small">Usa este tipo para registrar pérdidas, ventas manuales o productos dañados. Se RESTARÁ
                    del stock actual.</p>

                <h6><i class="bi bi-gear text-info"></i> Ajuste</h6>
                <p class="small">Usa este tipo para corregir el stock cuando hay diferencias en el inventario físico.
                    ESTABLECE el stock exacto.</p>
            </div>
        </div>

        <div class="card bg-warning bg-opacity-10 border-warning">
            <div class="card-body">
                <h6 class="text-warning"><i class="bi bi-exclamation-triangle"></i> Importante</h6>
                <p class="small mb-0">Las ventas normales NO deben registrarse aquí. El sistema reduce el stock
                    automáticamente al crear facturas.</p>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('.select2-producto').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Buscar producto...',
            allowClear: true
        });
    });

    document.getElementById('producto').addEventListener('change', updatePreview);
    document.getElementById('tipo').addEventListener('change', updatePreview);
    document.getElementById('cantidad').addEventListener('input', updatePreview);

    function updatePreview() {
        const productoSelect = document.getElementById('producto');
        const tipoSelect = document.getElementById('tipo');
        const cantidadInput = document.getElementById('cantidad');
        const previewAlert = document.getElementById('previewAlert');
        const previewContent = document.getElementById('previewContent');
        const cantidadHelp = document.getElementById('cantidadHelp');

        const productoOption = productoSelect.options[productoSelect.selectedIndex];
        const stockActual = parseFloat(productoOption.dataset.stock) || 0;
        const tipo = tipoSelect.value;
        const cantidad = parseFloat(cantidadInput.value) || 0;

        if (!tipo || !cantidad || stockActual === 0) {
            previewAlert.style.display = 'none';
            cantidadHelp.textContent = '';
            return;
        }

        let nuevoStock = stockActual;
        let mensaje = '';

        if (tipo === 'ENTRADA') {
            nuevoStock = stockActual + cantidad;
            mensaje = `Stock actual: ${stockActual} → Nuevo stock: <strong class="text-success">${nuevoStock.toFixed(3)}</strong> (+${cantidad})`;
            cantidadHelp.textContent = `Se agregarán ${cantidad} unidades al stock`;
            cantidadHelp.className = 'form-text text-success';
        } else if (tipo === 'SALIDA') {
            nuevoStock = stockActual - cantidad;
            if (nuevoStock < 0) {
                mensaje = `<span class="text-danger">⚠️ Error: Stock insuficiente. Stock actual: ${stockActual}</span>`;
                cantidadHelp.textContent = `No puedes restar ${cantidad} unidades, solo hay ${stockActual}`;
                cantidadHelp.className = 'form-text text-danger';
            } else {
                mensaje = `Stock actual: ${stockActual} → Nuevo stock: <strong class="text-danger">${nuevoStock.toFixed(3)}</strong> (-${cantidad})`;
                cantidadHelp.textContent = `Se restarán ${cantidad} unidades del stock`;
                cantidadHelp.className = 'form-text text-warning';
            }
        } else if (tipo === 'AJUSTE') {
            mensaje = `Stock actual: ${stockActual} → Nuevo stock: <strong class="text-info">${cantidad}</strong>`;
            const diferencia = cantidad - stockActual;
            if (diferencia > 0) {
                cantidadHelp.textContent = `Se ajustará el stock a ${cantidad} (aumenta en ${diferencia})`;
            } else if (diferencia < 0) {
                cantidadHelp.textContent = `Se ajustará el stock a ${cantidad} (disminuye en ${Math.abs(diferencia)})`;
            } else {
                cantidadHelp.textContent = `El stock quedará en ${cantidad} (sin cambios)`;
            }
            cantidadHelp.className = 'form-text text-info';
        }

        previewContent.innerHTML = mensaje;
        previewAlert.style.display = 'block';
    }
</script>
{% endblock %}